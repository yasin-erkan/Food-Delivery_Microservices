var stream = require('stream')

module.exports = function(opts) {

  opts = opts || { objectMode: true }

  return function(fn) {
    var s = new stream.Transform(opts)

    s._transform = function (chunk, encoding, done) {
      var that = this;
      var fin = function(data) {
        if (typeof data !== 'undefined') {
          that.push(data)
        }
        done()
      }
      var ret = fn.call(this, chunk, fin)
      if(ret) {
        this.push(ret)
        done()
      }
    }

    s._flush = function (done) {
      var ret = fn.call(this, null, done)
      if(ret || ret === null) {
        done()
      }
    }
    return s
  }
}
